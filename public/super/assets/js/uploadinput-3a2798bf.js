import{m as W}from"./@vueuse-0a258a1c.js";import{S as X,_ as q,l as O,k as Y,q as Z,i as x}from"./index-5e2104fc.js";import{a as F,E as ee}from"./element-plus-28d330eb.js";import{d as M,_ as P,e as V,$ as K,ag as h,o as y,c as S,V as r,P as p,T as z,O as A,n as L,aq as ae,aa as te,a as v,U as I,J as B,F as U,a8 as R,a9 as j,Q as le,K as ne,a3 as oe,u as T,S as se,D as ie}from"./@vue-110897a1.js";const re=M({name:"DiyUpload",props:{uploadTip:{type:String,required:!1,default:"请选择资源进行(支持拖拽)上传，"},multiple:{type:Boolean,required:!1,default:!0},showFileList:{type:Boolean,required:!1,default:!0},drag:{type:Boolean,required:!1,default:!1},accept:{type:String,required:!1,default:"*/*"},type:{type:String,required:!1,default:"image"},limit:{type:Number,required:!1,default:0},autoUpload:{type:Boolean,required:!1,default:!0},parentId:{type:String,required:!1,default:"0"}},emits:["update:value","upload","confirm"],setup(e,{emit:l}){const a=P({visible:!1,loading:!1,moduleName:"",tokenLoading:!1,uploadUrl:"/sys/storage/upload",params:{},headers:{Authorization:X.get("token")}}),g=V(),D=()=>{a.visible=!1,a.loading=!1,g.value&&g.value.clearFiles()},d=()=>{l("confirm"),D()},m=(o,c)=>{if(o.status==="success"&&o.response){const s=o.response.data;s&&s[0].storage_id}l("upload",c)},b=()=>{a.params.timestamp=Math.round(new Date().getTime()/1e3)+100,a.params.format="json",a.params.type=e.type,a.params.parentId=e.parentId,e.autoUpload&&(a.loading=!0)},f=(o,c,s)=>{if(o.code===200&&o.data){l("upload",s),k(s);return}C(o.msg,c,s)},C=(o,c,s)=>{F.error(o);for(let n=s.length-1;n>=0;n--)if(c===s[n]){s.splice(n,1),l("upload",s);break}k(s)},_=(o,c)=>{if(o.length+c.length>e.limit){const s=e.limit-c.length;F.error(`上传数量超出限制，最多还能选择 ${s} 个文件`)}},k=o=>{if(e.autoUpload){Object.keys(o).every(s=>o[s].status==="success")&&(a.loading=!1);let c=o.filter(s=>s.status==="success");c.length==o.length&&setTimeout(function(){g.value.clearFiles()},500),l("confirm",c)}};return{...K(a),upload:g,handleClose:D,handleConfirm:d,handleBeforeUpload:b,handleRemove:m,handleSuccess:f,handleError:C,handleExceed:_,handleChange:k}}});function de(e,l,a,g,D,d){const m=h("el-button"),b=h("el-upload");return y(),S("div",{class:"upload-control",onClick:l[0]||(l[0]=f=>e.visible=!0)},[r(b,{ref:"upload","list-type":"text",action:e.uploadUrl,data:e.params,multiple:e.multiple,"show-file-list":e.showFileList,drag:e.drag,accept:e.accept,limit:e.limit,headers:e.headers,"auto-upload":e.autoUpload,"on-remove":e.handleRemove,"before-upload":e.handleBeforeUpload,"on-success":e.handleSuccess,"on-error":e.handleError,"on-exceed":e.handleExceed},{default:p(()=>[r(m,{type:"primary"},{default:p(()=>[z("点击上传")]),_:1})]),_:1},8,["action","data","multiple","show-file-list","drag","accept","limit","headers","auto-upload","on-remove","before-upload","on-success","on-error","on-exceed"])])}const ue=q(re,[["render",de]]),ce=M({name:"DiyPagefooter",props:{current:{default:0},size:{default:0},total:{default:0},loading:{default:!1},isSize:{default:!0}},emits:["change"],setup(e,{emit:l}){const a=P({sizes:[10,15,25,50,100,250,500],layout:"total, sizes, prev, pager, next",simple:"total, prev, pager, next"});return{handleSizeChange:d=>{l("change",{current:e.current,size:d,total:e.total})},handleCurrentChange:d=>{l("change",{current:d,size:e.size,total:e.total})},...K(a)}}});function pe(e,l,a,g,D,d){const m=h("el-pagination");return y(),A(m,{small:"","page-size":e.size,total:e.total,"page-sizes":e.sizes,disabled:e.loading,layout:e.sizes.includes(e.size)&&e.isSize?e.layout:e.simple,onSizeChange:e.handleSizeChange,onCurrentChange:e.handleCurrentChange},null,8,["page-size","total","page-sizes","disabled","layout","onSizeChange","onCurrentChange"])}const me=q(ce,[["render",pe],["__scopeId","data-v-0ac2ae8b"]]),ge=M({name:"DiyStorage",components:{DiyUpload:ue,DiyPagefooter:me},props:{type:{default:"image"},accept:{default:"image/*"},limit:{type:Number,required:!1,default:0},isSelect:{default:"1"}},setup(e,{emit:l}){const a=P({baseUrl:"",title:"",isLoad:!1,icontype:"default",visible:!1,loading:!1,uploadConfig:{uploadTip:"请选择文件进行上传，",multiple:!0,accept:"image/*",limit:0,type:"image",replace:!1},storageType:e.type,source:"",loadingCollection:!1,checkList:[],categorys:[],syscategorys:[],currentTableData:[],currentSysTableData:[],searchSysTableData:[],dialogLoading:!1,nameForm:{type:"",name:void 0,parentId:void 0},nameFormVisible:!1,nameStatus:"edit",nameMap:{edit:"重命名",add:"新增目录"},iconfonturl:"",rules:{name:[{required:!0,message:"目录名称不能为空",trigger:"blur"},{max:255,message:"长度不能大于 255 个字符",trigger:"blur"}]},form:{name:void 0,parentId:void 0,order_type:"desc",order_field:"storageId"},sysform:{parentId:"icon1",name:"",type:"system"},page:{current:1,size:15,total:0}}),g=V(null),D=t=>t.type=="mp3"||t.type=="mp4"?"/static/images/mp3.png":t.type=="image"||t.type=="scene"?t.url:"/static/images/file.png",d=(t="",u="")=>{a.title=u||"文件管理",a.visible=!0,a.storageType=e.type,a.source=t,a.checkList=[],a.currentTableData.forEach(i=>{i.selectclz=""}),a.isLoad||(a.loadingCollection=!1,a.currentTableData=[],a.uploadConfig.type=e.type,f(),L(()=>{var i;G(),g.value&&((i=g.value)==null||i.handleClose())}))},m=t=>{a.page=t,L(()=>{f()})},b=()=>{a.page.current=1,f()},f=()=>{a.loading=!0,O("/sys/storage",{...a.form,type:a.storageType,pageNum:a.page.current,pageSize:a.page.size}).then(t=>{a.currentTableData=t.rows||[],a.page.total=t.total,a.isLoad=!0}).finally(()=>{a.loading=!1})},C=()=>{a.loading=!0,O("/sys/storage",{...a.sysform}).then(t=>{a.currentSysTableData=t.rows||[],a.searchSysTableData=t.rows||[]}).finally(()=>{a.loading=!1})},_=()=>{a.loading=!0,O("/sys/storage",{...a.sysform}).then(t=>{a.syscategorys=t.rows||[],a.sysform.type="system",a.sysform.parentId=t.rows[0].storageId,C()}).finally(()=>{a.loading=!1})},k=()=>{let t=a.currentSysTableData.filter(u=>u.name.indexOf(a.sysform.name)>=0||u.cname.indexOf(a.sysform.name)>=0);a.searchSysTableData=t},o=()=>{if(a.loading){F.error("点击过快，正在加载数据");return}a.sysform.parentId="",C()},c=()=>{if(a.checkList.length<=0){l("confirm",[],a.source),a.visible=!1;return}let t=a.checkList;a.loadingCollection=!1,a.visible=!1,l("confirm",t||[],a.source)},s=t=>{if(a.loading){F.error("点击过快，正在加载数据");return}a.form.parentId=t,f()},n=t=>{if(a.loading){F.error("点击过快，正在加载数据");return}a.sysform.name="",a.iconfonturl=t.url,a.sysform.parentId=t.storageId,C()},$=t=>{if(e.limit===1){a.currentSysTableData.forEach(i=>{i.selectclz=""}),a.currentTableData.forEach(i=>{i.selectclz=""});let u=a.checkList.findIndex(i=>i==t.storageId);u>=0?(a.checkList.splice(u,1),t.selectclz=""):a.checkList.length>0?(a.checkList.splice(0,1,t),t.selectclz="active"):(a.checkList.push(t),t.selectclz="active")}else{let u=a.checkList.findIndex(i=>i.storageId==t.storageId);u>=0?(a.checkList.splice(u,1),t.selectclz=""):(a.checkList.push(t),t.selectclz="active")}},w=t=>{const u=t?[t]:a.checkList;if(u.length===0){F.error("请选择要操作的数据");return}ee.confirm("确定要执行该操作吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",closeOnClickModal:!1}).then(()=>{Y("/sys/storage",u).then(()=>{for(let i=a.currentTableData.length-1;i>=0;i--)u.indexOf(a.currentTableData[i].storageId)!==-1&&a.currentTableData.splice(i,1);F.success("操作成功")})}).catch(()=>{})},J=t=>{for(const u of t){let i=u.response.data,N=a.currentTableData.findIndex(H=>H.url==i.url);N!=0&&(N>0&&a.currentTableData.splice(N,1),a.currentTableData.splice(0,0,i))}},E=V(),Q=V(),G=()=>{Z("/sys/storage",{type:"category"}).then(t=>{a.categorys=t.rows})};return{refform:E,refinput:Q,selectSystemCategory:n,rename:()=>{E.value.validate(t=>{t&&(a.dialogLoading=!0)})},add:()=>{E.value.validate(t=>{t&&(a.dialogLoading=!0,a.nameForm.type="category",x("/sys/storage",{...a.nameForm}).then(u=>{a.categorys.unshift({...u.data,is_default:0}),a.nameFormVisible=!1,F.success("操作成功")}).catch(()=>{a.dialogLoading=!1}))})},handleAdd:()=>{a.nameForm.name=void 0,a.nameForm.parentId=a.form.parentId,a.dialogLoading=!1,a.nameStatus="add",a.nameFormVisible=!0,L(()=>{E.value.clearValidate()})},handleClick:()=>{a.syscategorys.length==0&&a.icontype=="system"&&(a.sysform.type="systemcategorys",_())},...K(a),_getUploadFileList:J,selectCategory:s,getImageThumb:D,selectFile:$,handleDelete:w,handleSearch:b,handleAllSearch:o,handleConfirm:c,handlePaginationChange:m,handleStorageDlg:d,handleSysSearch:k}}});const fe={class:"flex storages"},ye={class:"categorys diy-tree file-border flex flex-direction-column"},he=["onClick"],ve={class:"flex1 file-border"},be={class:"flex justify-between"},Ce={class:"diy-mb-20"},ke=["max"],Se={class:"file-list"},De=["data-label"],Fe=["onClick"],ze={class:"file-name"},_e=["onClick"],Ie=["onClick"],Te={style:{float:"left","font-size":"13px"}},Ve={key:0,style:{color:"#f56c6c"}},$e={key:1};function we(e,l,a,g,D,d){const m=h("el-button"),b=h("SvgIcon"),f=h("el-input"),C=h("diy-upload"),_=h("diy-pagefooter"),k=h("el-dialog"),o=h("el-form-item"),c=h("el-form"),s=ae("loading");return y(),S(U,null,[r(k,{title:e.title,top:"5vh",modelValue:e.visible,"onUpdate:modelValue":l[6]||(l[6]=n=>e.visible=n),"append-to-body":"",center:"",width:"800px"},te({default:p(()=>[v("div",fe,[v("div",ye,[r(m,{type:"primary",onClick:l[0]||(l[0]=n=>e.handleAdd())},{default:p(()=>[z("新增目录")]),_:1}),v("div",{class:B(["mt-1 text-center",[e.form.parentId?"":"selected"]]),plain:"",onClick:l[1]||(l[1]=n=>e.selectCategory(""))},"全部",2),(y(!0),S(U,null,R(e.categorys,n=>(y(),S("div",{class:B(["mt-1 p-1 text-center",[e.form.parentId==n.storageId?"selected":""]]),plain:"",key:n,onClick:$=>e.selectCategory(n.storageId)},I(n.name),11,he))),128))]),v("div",ve,[v("div",be,[v("div",Ce,[r(f,{modelValue:e.form.name,"onUpdate:modelValue":l[2]||(l[2]=n=>e.form.name=n),"label-width":"0px",placeholder:"输入名称搜索",style:{width:"250px"},onKeyup:l[3]||(l[3]=j(n=>e.handleSearch(),["enter","native"])),onClear:l[4]||(l[4]=n=>e.handleSearch()),clearable:!0},{suffix:p(()=>[r(b,{onClick:e.handleSearch,name:"ele-Search",size:20},null,8,["onClick"])]),_:1},8,["modelValue"])]),r(C,{ref:"upload","upload-tip":e.uploadConfig.uploadTip,multiple:e.uploadConfig.multiple,type:e.type,accept:e.accept,limit:e.uploadConfig.limit,"parent-id":e.form.parentId,onConfirm:e._getUploadFileList},null,8,["upload-tip","multiple","type","accept","limit","parent-id","onConfirm"])]),v("div",{class:"files",max:e.limit!==0?e.limit:100},[le((y(),S("div",Se,[(y(!0),S(U,null,R(e.currentTableData,(n,$)=>(y(),S("div",{key:$,class:B(["item",n.selectclz]),"data-label":n.name},[v("div",{class:"file-image",style:ne({backgroundImage:"url("+e.getImageThumb(n)+")"}),onClick:w=>e.selectFile(n)},null,12,Fe),v("div",ze,I(n.name),1),v("div",{class:"mask",onClick:w=>e.selectFile(n)},[r(b,{name:"ele-Check",size:20})],8,_e),v("div",{class:"el-dropdown",onClick:w=>e.handleDelete(n.storageId)},[r(b,{class:"delete",name:"ele-Delete",size:20})],8,Ie)],10,De))),128))])),[[s,e.loading]])],8,ke),r(_,{style:{margin:"0",padding:"20px 0 0 0"},current:e.page.current,size:e.page.size,total:e.page.total,"is-size":!1,onChange:e.handlePaginationChange},null,8,["current","size","total","onChange"])])])]),_:2},[e.isSelect=="1"?{name:"footer",fn:p(()=>[v("div",Te,[e.checkList.length>e.limit&&e.limit!==0?(y(),S("span",Ve," 当前已选 "+I(e.checkList.length)+" 个，最多允许选择 "+I(e.limit)+" 个文件 ",1)):(y(),S("span",$e,"当前已选 "+I(e.checkList.length)+" 个文件",1))]),r(m,{onClick:l[5]||(l[5]=n=>e.visible=!1)},{default:p(()=>[z("取消")]),_:1}),r(m,{type:"primary",loading:e.loadingCollection,disabled:e.checkList.length>e.limit&&e.limit!==0,onClick:e.handleConfirm},{default:p(()=>[z("确定")]),_:1},8,["loading","disabled","onClick"])]),key:"0"}:void 0]),1032,["title","modelValue"]),r(k,{title:e.nameMap[e.nameStatus],modelValue:e.nameFormVisible,"onUpdate:modelValue":l[11]||(l[11]=n=>e.nameFormVisible=n),"append-to-body":"",center:"",top:"5vh",width:"600px"},{footer:p(()=>[r(m,{onClick:l[10]||(l[10]=n=>e.nameFormVisible=!1)},{default:p(()=>[z("取消")]),_:1}),e.nameStatus==="add"?(y(),A(m,{key:0,type:"primary",loading:e.dialogLoading,onClick:e.add},{default:p(()=>[z("确定")]),_:1},8,["loading","onClick"])):(y(),A(m,{key:1,type:"primary",loading:e.dialogLoading,onClick:e.rename},{default:p(()=>[z("修改")]),_:1},8,["loading","onClick"]))]),default:p(()=>[r(c,{model:e.nameForm,rules:e.rules,ref:"refform","label-width":"50px","label-position":"left",onSubmit:l[9]||(l[9]=oe(()=>{},["prevent"]))},{default:p(()=>[r(o,{label:"名称",prop:"name"},{default:p(()=>[r(f,{modelValue:e.nameForm.name,"onUpdate:modelValue":l[7]||(l[7]=n=>e.nameForm.name=n),placeholder:"请输入目录名称",onKeyup:l[8]||(l[8]=j(n=>e.nameStatus==="add"?e.add():e.rename(),["enter","native"])),ref:"input"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])],64)}const Ee=q(ge,[["render",we],["__scopeId","data-v-8d2a27e6"]]),Le=M({__name:"uploadinput",props:{modelValue:{type:String,default:""},title:{type:String,default:""},type:{type:String,default:"image"},accept:{type:String,default:"image/*"}},emits:["update:modelValue"],setup(e,{emit:l}){const a=e,g=V(null),d=W(a,"modelValue",l),m=()=>{L(()=>{g.value.handleStorageDlg("","上传"+a.title)})},b=(f=[])=>{f.length&&(d.value=f[0].url)};return(f,C)=>{const _=h("el-image"),k=h("el-button"),o=h("el-input");return y(),S(U,null,[r(o,{type:"text",class:B(T(d)&&e.type=="image"?"diygw-img-input":""),modelValue:T(d),"onUpdate:modelValue":C[0]||(C[0]=c=>ie(d)?d.value=c:null),clearable:"",placeholder:"请选择"+e.title},{append:p(()=>[T(d)&&e.type=="image"?(y(),A(_,{key:0,src:T(d),style:{width:"30px",height:"30px"},"preview-teleported":!0,"preview-src-list":[T(d)]},null,8,["src","preview-src-list"])):se("",!0),r(k,{onClick:m},{default:p(()=>[z(" 选择"+I(e.title),1)]),_:1})]),_:1},8,["class","modelValue","placeholder"]),r(Ee,{ref_key:"storage",ref:g,type:e.type,accept:e.accept,limit:1,onConfirm:b},null,8,["type","accept"])],64)}}});const Ke=q(Le,[["__scopeId","data-v-f457c92d"]]);export{Ke as D,Ee as a};
